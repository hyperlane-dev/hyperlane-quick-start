<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>CICD Management - Hyperlane</title>
    <link rel="icon" href="https://docs.ltpp.vip/img/hyperlane.png" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        scrollbar-width: thin;
        scrollbar-color: #424242 #1a1a1a;
      }

      *::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      *::-webkit-scrollbar-track {
        background: #1a1a1a;
      }

      *::-webkit-scrollbar-thumb {
        background: #424242;
        border-radius: 4px;
      }

      *::-webkit-scrollbar-thumb:hover {
        background: #555;
      }

      input,
      textarea,
      select {
        user-select: text !important;
        -webkit-user-select: text !important;
        -moz-user-select: text !important;
        -ms-user-select: text !important;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        background: #0d1117;
        color: #c9d1d9;
        min-height: 100vh;
      }

      .header {
        background: #161b22;
        border-bottom: 1px solid #30363d;
        padding: 16px 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .header h1 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #f0f6fc;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .header h1 a {
        color: inherit;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .header h1 .icon {
        font-size: 1.5rem;
      }

      .btn {
        padding: 6px 16px;
        border: 1px solid #30363d;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        background: #21262d;
        color: #c9d1d9;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .btn:hover {
        background: #30363d;
        border-color: #8b949e;
      }

      .btn-primary {
        background: #238636;
        border-color: #238636;
        color: #fff;
      }

      .btn-primary:hover {
        background: #2ea043;
        border-color: #2ea043;
      }

      .btn-danger {
        background: #da3633;
        border-color: #da3633;
        color: #fff;
      }

      .btn-danger:hover {
        background: #f85149;
        border-color: #f85149;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
      }

      .tabs {
        display: flex;
        gap: 4px;
        border-bottom: 1px solid #30363d;
        margin-bottom: 24px;
      }

      .tab {
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        color: #8b949e;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .tab:hover {
        color: #c9d1d9;
      }

      .tab.active {
        color: #f0f6fc;
        border-bottom-color: #f78166;
      }

      .tab .count {
        background: #30363d;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 12px;
        font-weight: 600;
      }

      .card {
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 16px;
      }

      .card-header {
        padding: 16px 20px;
        border-bottom: 1px solid #30363d;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .card-title {
        font-size: 16px;
        font-weight: 600;
        color: #f0f6fc;
      }

      .card-body {
        padding: 20px;
      }

      .pipeline-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .pipeline-item {
        background: #0d1117;
        border: 1px solid #30363d;
        border-radius: 8px;
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 16px;
        transition: all 0.2s;
        cursor: pointer;
      }

      .pipeline-item:hover {
        border-color: #58a6ff;
        background: #161b22;
      }

      .pipeline-status {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        flex-shrink: 0;
      }

      .pipeline-status.active {
        background: #238636;
        box-shadow: 0 0 8px #238636;
      }

      .pipeline-status.inactive {
        background: #8b949e;
      }

      .pipeline-info {
        flex: 1;
        min-width: 0;
      }

      .pipeline-name {
        font-size: 16px;
        font-weight: 600;
        color: #58a6ff;
        margin-bottom: 4px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .pipeline-meta {
        font-size: 12px;
        color: #8b949e;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .pipeline-actions {
        display: flex;
        gap: 8px;
        flex-shrink: 0;
      }

      .run-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .run-item {
        background: #0d1117;
        border: 1px solid #30363d;
        border-radius: 8px;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .run-item:hover {
        background: #161b22;
        border-color: #58a6ff;
      }

      .run-status {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        line-height: 1;
        flex-shrink: 0;
      }

      .run-status.success {
        background: #238636;
        color: #fff;
      }

      .run-status.failure {
        background: #da3633;
        color: #fff;
        padding-bottom: 3px;
      }

      .loading-more {
        text-align: center;
        padding: 20px;
        color: #8b949e;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .loading-more.hidden {
        display: none;
      }

      .loading-spinner {
        width: 16px;
        height: 16px;
        border: 2px solid #30363d;
        border-top-color: #58a6ff;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .run-status.pending {
        background: #8b949e;
        color: #fff;
      }

      .run-status.running {
        background: #1f6feb;
        color: #fff;
        animation: pulse 1.5s infinite;
      }

      .run-status.cancelled {
        background: #6e7681;
        color: #fff;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .run-info {
        flex: 1;
        min-width: 0;
      }

      .run-title {
        font-size: 14px;
        font-weight: 500;
        color: #f0f6fc;
        margin-bottom: 2px;
      }

      .run-meta {
        font-size: 12px;
        color: #8b949e;
      }

      .run-time {
        font-size: 12px;
        color: #8b949e;
        text-align: right;
        flex-shrink: 0;
      }

      .form-group {
        margin-bottom: 16px;
      }

      .form-label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: #c9d1d9;
        margin-bottom: 8px;
      }

      .form-input,
      .form-textarea,
      .form-select {
        width: 100%;
        padding: 8px 12px;
        background: #0d1117;
        border: 1px solid #30363d;
        border-radius: 6px;
        color: #c9d1d9;
        font-size: 14px;
        transition: all 0.2s;
      }

      .form-input:focus,
      .form-textarea:focus,
      .form-select:focus {
        outline: none;
        border-color: #58a6ff;
        box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
      }

      .form-textarea {
        min-height: 200px;
        font-family: 'SFMono-Regular', monospace;
        font-size: 13px;
        line-height: 1.5;
        resize: none;
        overflow: hidden;
      }

      .config-mode-toggle {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
      }

      .toggle-label {
        font-size: 14px;
        font-weight: 500;
        color: #c9d1d9;
      }

      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 48px;
        height: 24px;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #30363d;
        transition: 0.3s;
        border-radius: 24px;
      }

      .toggle-slider:before {
        position: absolute;
        content: '';
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: #c9d1d9;
        transition: 0.3s;
        border-radius: 50%;
      }

      .toggle-switch input:checked + .toggle-slider {
        background-color: #238636;
      }

      .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(24px);
        background-color: #fff;
      }

      .mode-hint {
        font-size: 12px;
        color: #8b949e;
        margin-left: auto;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 24px;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 12px;
        max-width: 700px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-header {
        padding: 20px;
        border-bottom: 1px solid #30363d;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-title {
        font-size: 18px;
        font-weight: 600;
        color: #f0f6fc;
      }

      .modal-close {
        background: none;
        border: none;
        color: #8b949e;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        transition: all 0.2s;
      }

      .modal-close:hover {
        background: #30363d;
        color: #f0f6fc;
      }

      .modal-body {
        padding: 20px;
      }

      .modal-footer {
        padding: 16px 20px;
        border-top: 1px solid #30363d;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #8b949e;
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
      }

      .empty-state-title {
        font-size: 20px;
        font-weight: 600;
        color: #f0f6fc;
        margin-bottom: 8px;
      }

      .job-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 16px;
      }

      .job-item {
        background: #0d1117;
        border: 1px solid #30363d;
        border-radius: 8px;
        overflow: hidden;
      }

      .job-header {
        padding: 12px 16px;
        background: #161b22;
        border-bottom: 1px solid #30363d;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .job-name {
        font-weight: 600;
        color: #f0f6fc;
        flex: 1;
      }

      .step-list {
        padding: 8px;
      }

      .step-item {
        border-radius: 6px;
        display: flex;
        flex-direction: column;
        transition: all 0.2s;
      }

      .step-header-row {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .step-header-row:hover {
        background: #21262d;
      }

      .step-status {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        flex-shrink: 0;
      }

      .step-status.success {
        background: #238636;
        color: #fff;
      }
      .step-status.failure {
        background: #da3633;
        color: #fff;
      }
      .step-status.pending {
        background: #8b949e;
        color: #fff;
      }
      .step-status.running {
        background: #1f6feb;
        color: #fff;
        animation: pulse 1.5s infinite;
      }
      .step-status.skipped {
        background: #6e7681;
        color: #fff;
      }

      .step-name {
        flex: 1;
        font-size: 13px;
        color: #c9d1d9;
      }

      .step-time {
        font-size: 12px;
        color: #8b949e;
      }

      .log-output {
        background: #0d1117;
        border: 1px solid #30363d;
        border-radius: 6px;
        padding: 16px;
        font-family:
          'SFMono-Regular', 'Monaco', 'Inconsolata', 'Fira Code', 'Consolas',
          'Courier New', monospace;
        font-size: 12px;
        line-height: 1.6;
        color: #c9d1d9;
        max-height: 400px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-break: break-all;
      }

      .log-line {
        padding: 2px 0;
      }

      .log-timestamp {
        color: #6e7681;
        margin-right: 8px;
        user-select: none;
      }

      .log-section {
        color: #58a6ff;
        font-weight: 600;
        margin-top: 8px;
        margin-bottom: 4px;
      }

      .log-error {
        color: #f85149;
        background: rgba(248, 81, 73, 0.1);
        padding: 0 4px;
        border-radius: 3px;
      }

      .log-warning {
        color: #f0883e;
        background: rgba(240, 136, 62, 0.1);
        padding: 0 4px;
        border-radius: 3px;
      }

      .log-success {
        color: #3fb950;
        background: rgba(63, 185, 80, 0.1);
        padding: 0 4px;
        border-radius: 3px;
      }

      .log-info {
        color: #58a6ff;
      }

      .log-command {
        color: #d2a8ff;
        font-weight: 500;
      }

      .log-hash {
        color: #79c0ff;
      }

      .log-url {
        color: #a5d6ff;
        text-decoration: underline;
        cursor: pointer;
      }

      .log-docker-step {
        color: #ff7b72;
        font-weight: 500;
      }

      .log-docker-done {
        color: #3fb950;
      }

      .log-docker-cache {
        color: #f0883e;
      }

      .step-log-container {
        background: #0d1117;
        border-top: 1px solid #21262d;
        overflow: hidden;
      }

      .step-log-header {
        padding: 8px 16px;
        background: #161b22;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        transition: background 0.2s;
      }

      .step-log-header:hover {
        background: #21262d;
      }

      .step-log-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #8b949e;
        font-size: 12px;
      }

      .step-log-toggle-icon {
        transition: transform 0.2s;
        font-size: 10px;
      }

      .step-log-toggle-icon.collapsed {
        transform: rotate(-90deg);
      }

      .step-log-content {
        padding: 12px 16px;
        font-family:
          'SFMono-Regular', 'Monaco', 'Inconsolata', 'Fira Code', 'Consolas',
          'Courier New', monospace;
        font-size: 12px;
        line-height: 1.6;
        color: #c9d1d9;
      }

      .step-log-content.collapsed {
        display: none;
      }

      .hidden {
        display: none !important;
      }

      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .toast {
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 8px;
        padding: 12px 16px;
        min-width: 280px;
        max-width: 400px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        animation: slideIn 0.3s ease;
        cursor: pointer;
      }

      .toast.hiding {
        animation: slideOut 0.3s ease forwards;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      .toast-icon {
        font-size: 18px;
        flex-shrink: 0;
      }

      .toast-icon.success {
        color: #238636;
      }

      .toast-icon.error {
        color: #da3633;
      }

      .toast-icon.info {
        color: #58a6ff;
      }

      .toast-content {
        flex: 1;
        font-size: 14px;
        color: #c9d1d9;
      }

      .detail-header {
        margin-bottom: 24px;
      }

      .detail-title {
        font-size: 24px;
        font-weight: 600;
        color: #f0f6fc;
        margin-bottom: 8px;
      }

      .detail-meta {
        display: flex;
        gap: 16px;
        color: #8b949e;
        font-size: 14px;
      }

      .back-btn {
        margin-bottom: 16px;
      }

      @media (max-width: 768px) {
        .header {
          padding: 12px 16px;
        }

        .header h1 {
          font-size: 1rem;
        }

        .header h1 span:last-child {
          display: none;
        }

        .container {
          padding: 12px;
        }

        .tabs {
          margin-bottom: 16px;
        }

        .tab {
          padding: 10px 12px;
          font-size: 13px;
        }

        .tab .count {
          padding: 1px 6px;
          font-size: 11px;
        }

        .pipeline-item {
          padding: 12px;
        }

        .pipeline-name {
          font-size: 14px;
        }

        .pipeline-meta {
          font-size: 11px;
          gap: 8px;
        }

        .pipeline-actions .btn {
          white-space: nowrap;
          flex-shrink: 0;
          padding: 6px 12px;
          font-size: 13px;
        }

        .run-item {
          flex-wrap: wrap;
          padding: 10px 12px;
          gap: 10px;
        }

        .run-info {
          flex: 1;
          min-width: 0;
        }

        .run-title {
          font-size: 13px;
        }

        .run-meta {
          font-size: 11px;
        }

        .run-time {
          width: 100%;
          text-align: left;
          margin-top: 4px;
          font-size: 11px;
        }

        .btn {
          padding: 5px 12px;
          font-size: 13px;
        }

        .modal-content {
          max-width: 100%;
          max-height: 95vh;
          margin: 10px;
          border-radius: 8px;
        }

        .modal-header {
          padding: 16px;
        }

        .modal-title {
          font-size: 16px;
        }

        .modal-body {
          padding: 16px;
        }

        .modal-footer {
          padding: 12px 16px;
        }

        .form-group {
          margin-bottom: 12px;
        }

        .form-label {
          font-size: 13px;
          margin-bottom: 6px;
        }

        .form-input,
        .form-select {
          padding: 8px 10px;
          font-size: 16px;
        }

        .form-textarea {
          min-height: 150px;
          font-size: 13px;
        }

        .detail-title {
          font-size: 18px;
        }

        .detail-meta {
          flex-wrap: wrap;
          gap: 8px;
          font-size: 12px;
        }

        .job-header {
          padding: 10px 12px;
        }

        .job-name {
          font-size: 14px;
        }

        .step-header-row {
          padding: 8px 10px;
        }

        .step-name {
          font-size: 12px;
        }

        .log-output {
          padding: 12px;
          font-size: 11px;
          max-height: 300px;
        }

        .step-log-content {
          padding: 10px 12px;
          font-size: 11px;
        }

        .card-header {
          padding: 12px 16px;
        }

        .card-title {
          font-size: 14px;
        }

        .card-body {
          padding: 16px;
        }

        .back-btn {
          margin-bottom: 12px;
        }

        .toast-container {
          top: 10px;
          right: 10px;
          left: 10px;
        }

        .toast {
          min-width: auto;
          max-width: 100%;
          padding: 10px 12px;
        }

        .empty-state {
          padding: 40px 16px;
        }

        .empty-state-icon {
          font-size: 36px;
        }

        .empty-state-title {
          font-size: 16px;
        }
      }

      @media (max-width: 480px) {
        .header {
          padding: 10px 12px;
        }

        .header h1 {
          font-size: 0.9rem;
        }

        .container {
          padding: 8px;
        }

        .pipeline-item {
          padding: 10px;
        }

        .pipeline-actions {
          justify-content: stretch;
        }

        .pipeline-actions .btn {
          flex: 1;
          justify-content: center;
        }

        .tab {
          padding: 8px 10px;
          font-size: 12px;
        }

        .tab .count {
          display: none;
        }

        .modal-content {
          margin: 5px;
          border-radius: 6px;
        }

        .modal-header,
        .modal-body,
        .modal-footer {
          padding: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="header-left">
        <h1>
          <a href="https://github.com/hyperlane-dev/hyperlane" target="_blank">
            <span class="icon">üöÄ</span>
            <span>Hyperlane CICD</span>
          </a>
        </h1>
      </div>
      <button class="btn btn-primary" onclick="showCreateModal()">
        <span>+</span> New Pipeline
      </button>
    </div>

    <div class="container">
      <div class="tabs">
        <div class="tab active" onclick="switchTab('pipelines')">
          Pipelines <span class="count" id="pipeline-count">0</span>
        </div>
        <div class="tab" onclick="switchTab('runs')">
          Runs <span class="count" id="run-count">0</span>
        </div>
      </div>

      <div id="pipelines-view">
        <div class="card">
          <div class="card-header">
            <span class="card-title">All Pipelines</span>
          </div>
          <div class="card-body">
            <div class="pipeline-list" id="pipeline-list">
              <div class="empty-state">
                <div class="empty-state-icon">üì¶</div>
                <div class="empty-state-title">No pipelines yet</div>
                <p>Create your first pipeline to get started</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="runs-view" class="hidden">
        <div class="card">
          <div class="card-header">
            <span class="card-title">Recent Runs</span>
          </div>
          <div class="card-body">
            <div class="run-list" id="run-list">
              <div class="empty-state">
                <div class="empty-state-icon">‚ñ∂Ô∏è</div>
                <div class="empty-state-title">No runs yet</div>
                <p>Trigger a pipeline to see runs here</p>
              </div>
            </div>
            <div class="loading-more hidden" id="loading-more">
              <div class="loading-spinner"></div>
              <span>Loading more...</span>
            </div>
          </div>
        </div>
      </div>

      <div id="run-detail-view" class="hidden">
        <button class="btn back-btn" onclick="backToRuns()">
          ‚Üê Back to Runs
        </button>
        <div class="detail-header">
          <div class="detail-title" id="detail-title">Run #1</div>
          <div class="detail-meta" id="detail-meta"></div>
        </div>
        <div class="job-list" id="job-list"></div>
      </div>
    </div>

    <div class="modal" id="create-modal">
      <div class="modal-content">
        <div class="modal-header">
          <span class="modal-title">Create New Pipeline</span>
          <button class="modal-close" onclick="closeModal('create-modal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Pipeline Name *</label>
            <input
              type="text"
              class="form-input"
              id="create-name"
              placeholder="e.g., Build and Test"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Description</label>
            <input
              type="text"
              class="form-input"
              id="create-description"
              placeholder="Brief description of this pipeline"
            />
          </div>
          <div class="form-group">
            <div class="config-mode-toggle">
              <span class="toggle-label">Use Dockerfile</span>
              <label class="toggle-switch">
                <input
                  type="checkbox"
                  id="create-mode-dockerfile"
                  onchange="toggleCreateMode()"
                />
                <span class="toggle-slider"></span>
              </label>
              <span class="mode-hint" id="create-mode-hint">YAML mode</span>
            </div>
            <label class="form-label" id="create-config-label"
              >Pipeline Config (YAML)</label
            >
            <textarea class="form-textarea" id="create-config">
name: Hello World Pipeline
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Hello World Step
        run: echo 'hello world'</textarea
            >
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" onclick="closeModal('create-modal')">
            Cancel
          </button>
          <button class="btn btn-primary" onclick="createPipeline()">
            Create Pipeline
          </button>
        </div>
      </div>
    </div>

    <div class="modal" id="run-config-modal">
      <div class="modal-content">
        <div class="modal-header">
          <span class="modal-title" id="run-config-title"
            >Confirm Run Pipeline</span
          >
          <button class="modal-close" onclick="closeModal('run-config-modal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Pipeline Name</label>
            <div
              class="form-input"
              id="run-config-pipeline-name"
              style="background: #0d1117; cursor: default"
            ></div>
          </div>
          <div class="form-group">
            <label class="form-label">Configuration</label>
            <pre
              class="form-textarea"
              id="run-config-content"
              style="
                background: #0d1117;
                overflow: auto;
                min-height: 300px;
                cursor: default;
                white-space: pre-wrap;
                word-wrap: break-word;
                font-family: 'SFMono-Regular', monospace;
                font-size: 13px;
                line-height: 1.5;
              "
            ></pre>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" onclick="closeModal('run-config-modal')">
            Cancel
          </button>
          <button
            class="btn btn-primary"
            id="run-config-confirm-btn"
            onclick="confirmTriggerPipeline()"
          >
            Confirm Run
          </button>
        </div>
      </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script>
      let pipelines = [];
      let runs = [];
      let currentRunDetail = null;
      let runsPollingInterval = null;
      let detailPollingInterval = null;
      let expandedSteps = new Set();
      let lastRunId = null;
      const RUNS_PAGE_SIZE = 50;
      let runsHasMore = true;
      let isLoadingMoreRuns = false;
      let logEventSource = null;
      let stepOutputOffsets = new Map();

      function showToast(message, type = 'info', duration = 3000) {
        const container = document.getElementById('toast-container');
        if (!container) return;

        const toast = document.createElement('div');
        toast.className = 'toast';

        const iconMap = {
          success: '‚úì',
          error: '‚úó',
          info: '‚Ñπ',
        };

        toast.innerHTML = `
          <span class="toast-icon ${type}">${iconMap[type] || iconMap.info}</span>
          <span class="toast-content">${escapeHtml(message)}</span>
        `;

        toast.addEventListener('click', () => hideToast(toast));

        container.appendChild(toast);

        setTimeout(() => hideToast(toast), duration);
      }

      function hideToast(toast) {
        if (!toast || toast.classList.contains('hiding')) return;
        toast.classList.add('hiding');
        setTimeout(() => toast.remove(), 300);
      }

      function setLoadingMoreIndicator(show) {
        const indicator = document.getElementById('loading-more');
        if (indicator) {
          if (show && runsHasMore) {
            indicator.classList.remove('hidden');
          } else {
            indicator.classList.add('hidden');
          }
        }
      }

      function handleScroll() {
        const runsView = document.getElementById('runs-view');
        if (runsView.classList.contains('hidden')) return;

        const scrollTop = window.scrollY || document.documentElement.scrollTop;
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;

        if (scrollTop + windowHeight >= documentHeight - 100) {
          if (!isLoadingMoreRuns && runsHasMore) {
            loadRuns(false);
          }
        }
      }

      window.addEventListener('scroll', handleScroll);

      function switchTab(tab, updateHash = true) {
        document
          .querySelectorAll('.tab')
          .forEach((t) => t.classList.remove('active'));
        document
          .querySelector(`.tab[onclick="switchTab('${tab}')"]`)
          .classList.add('active');

        document.getElementById('pipelines-view').classList.add('hidden');
        document.getElementById('runs-view').classList.add('hidden');
        document.getElementById('run-detail-view').classList.add('hidden');

        if (tab === 'pipelines') {
          document.getElementById('pipelines-view').classList.remove('hidden');
          loadPipelines();
        } else {
          document.getElementById('runs-view').classList.remove('hidden');
          loadRuns(true);
        }

        if (updateHash) {
          window.location.hash = tab;
        }
      }

      function autoResizeTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.max(200, textarea.scrollHeight) + 'px';
      }

      function setupAutoResizeTextarea(textareaId) {
        const textarea = document.getElementById(textareaId);
        if (!textarea) return;
        textarea.addEventListener('input', function () {
          autoResizeTextarea(this);
        });
        textarea.addEventListener('focus', function () {
          autoResizeTextarea(this);
        });
        autoResizeTextarea(textarea);
      }

      function showCreateModal() {
        document.getElementById('create-name').value = '';
        document.getElementById('create-description').value = '';
        document.getElementById('create-mode-dockerfile').checked = false;
        document.getElementById('create-config').value = DEFAULT_CONFIG;
        document.getElementById('create-config-label').textContent =
          'Pipeline Config (YAML)';
        document.getElementById('create-mode-hint').textContent = 'YAML mode';
        document.getElementById('create-modal').classList.add('active');
        setTimeout(() => {
          setupAutoResizeTextarea('create-config');
        }, 0);
      }

      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
      }

      async function loadPipelines() {
        try {
          const response = await fetch('/api/cicd/pipeline/list');
          const result = await response.json();
          if (result.code === 200) {
            pipelines = result.data || [];
            renderPipelines();
          }
        } catch (error) {
          console.error('Error loading pipelines:', error);
        }
      }

      function renderPipelines() {
        document.getElementById('pipeline-count').textContent =
          pipelines.length;
        const container = document.getElementById('pipeline-list');

        if (pipelines.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üì¶</div>
              <div class="empty-state-title">No pipelines yet</div>
              <p>Create your first pipeline to get started</p>
            </div>
          `;
          return;
        }

        container.innerHTML = pipelines
          .map(
            (p) => `
          <div class="pipeline-item" data-pipeline-id="${p.id}" data-pipeline-name="${escapeHtml(p.name)}" data-pipeline-config="${escapeHtml(p.config_content || '')}" onclick="showRunConfigModal(${p.id})">
            <div class="pipeline-info">
              <div class="pipeline-name">${escapeHtml(p.name)}</div>
            </div>
            <div class="pipeline-actions" onclick="event.stopPropagation();">
              <button class="btn btn-primary" onclick="triggerPipeline(${p.id})">Run</button>
            </div>
          </div>
        `,
          )
          .join('');
      }

      const DEFAULT_CONFIG = `name: Hello World Pipeline
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Hello World Step
        run: echo 'hello world'`;

      const DOCKERFILE_CONFIG = `name: Docker Build Pipeline
image: alpine:latest
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Build with Dockerfile
        dockerfile: |
          FROM alpine:latest
          RUN echo 'Building from Dockerfile...'
          CMD echo 'Hello from Docker container!'`;

      function toggleCreateMode() {
        const isDockerfileMode = document.getElementById(
          'create-mode-dockerfile',
        ).checked;
        const configTextarea = document.getElementById('create-config');
        const configLabel = document.getElementById('create-config-label');
        const modeHint = document.getElementById('create-mode-hint');

        if (isDockerfileMode) {
          configTextarea.value = DOCKERFILE_CONFIG;
          configLabel.textContent = 'Pipeline Config (Dockerfile Mode)';
          modeHint.textContent = 'Dockerfile mode';
        } else {
          configTextarea.value = DEFAULT_CONFIG;
          configLabel.textContent = 'Pipeline Config (YAML)';
          modeHint.textContent = 'YAML mode';
        }
        setupAutoResizeTextarea('create-config');
      }

      async function createPipeline() {
        const configValue = document
          .getElementById('create-config')
          .value.trim();
        const data = {
          name: document.getElementById('create-name').value,
          description:
            document.getElementById('create-description').value || null,
          config_content: configValue || DEFAULT_CONFIG,
        };

        if (!data.name) {
          showToast('Pipeline name is required', 'error');
          return;
        }

        try {
          const response = await fetch('/api/cicd/pipeline/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });
          const result = await response.json();
          if (result.code === 200) {
            closeModal('create-modal');
            loadPipelines();
            document.getElementById('create-name').value = '';
            document.getElementById('create-description').value = '';
            document.getElementById('create-config').value = '';
            showToast('Pipeline created successfully', 'success');
          } else {
            showToast('Error: ' + result.message, 'error');
          }
        } catch (error) {
          showToast('Network error: ' + error.message, 'error');
        }
      }

      let currentRunPipelineId = null;

      function showRunConfigModal(id) {
        const pipelineItem = document.querySelector(
          `.pipeline-item[data-pipeline-id="${id}"]`,
        );
        if (!pipelineItem) return;

        const name =
          pipelineItem.getAttribute('data-pipeline-name') || 'Unknown';
        const config =
          pipelineItem.getAttribute('data-pipeline-config') ||
          'No configuration available';

        currentRunPipelineId = id;
        document.getElementById('run-config-pipeline-name').textContent = name;
        document.getElementById('run-config-content').textContent = config;
        document.getElementById('run-config-modal').classList.add('active');
      }

      async function confirmTriggerPipeline() {
        if (!currentRunPipelineId) return;

        closeModal('run-config-modal');
        await triggerPipeline(currentRunPipelineId);
        currentRunPipelineId = null;
      }

      async function triggerPipeline(id) {
        try {
          const response = await fetch('/api/cicd/run/trigger', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              pipeline_id: id,
              triggered_by: 'user',
            }),
          });
          const result = await response.json();
          if (result.code === 200) {
            showToast(
              'Pipeline triggered successfully! Run ID: ' + result.data,
              'success',
            );
            await loadRuns(true);
          } else {
            showToast('Error: ' + result.message, 'error');
          }
        } catch (error) {
          showToast('Network error: ' + error.message, 'error');
        }
      }

      async function loadRuns(reset = false) {
        if (isLoadingMoreRuns) return;
        if (reset) {
          lastRunId = null;
          runsHasMore = true;
          runs = [];
        }
        if (!runsHasMore && !reset) return;

        isLoadingMoreRuns = true;
        setLoadingMoreIndicator(true);

        try {
          const url = lastRunId
            ? `/api/cicd/run/list?page_size=${RUNS_PAGE_SIZE}&last_id=${lastRunId}`
            : `/api/cicd/run/list?page_size=${RUNS_PAGE_SIZE}`;
          const response = await fetch(url);
          const result = await response.json();
          if (result.code === 200) {
            const newRuns = result.data?.runs || [];
            const total = result.data?.total || 0;

            lastFetchedRuns = newRuns;
            if (reset) {
              runs = newRuns;
            } else {
              runs = runs.concat(newRuns);
            }

            runsHasMore = result.data?.has_more ?? false;
            document.getElementById('run-count').textContent = total;
            renderRuns(!reset);

            if (newRuns.length > 0) {
              lastRunId = newRuns[newRuns.length - 1].id;
            }
          }
        } catch (error) {
          console.error('Error loading runs:', error);
        } finally {
          isLoadingMoreRuns = false;
          setLoadingMoreIndicator(false);
        }
      }

      let lastFetchedRuns = [];

      function renderRuns(append = false) {
        const container = document.getElementById('run-list');

        if (runs.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">‚ñ∂Ô∏è</div>
              <div class="empty-state-title">No runs yet</div>
              <p>Trigger a pipeline to see runs here</p>
            </div>
          `;
          return;
        }

        const runsToRender = append ? lastFetchedRuns : runs;
        const newRunsHtml = runsToRender
          .map(
            (r) => `
          <div class="run-item" onclick="viewRunDetail(${r.id})">
            <div class="run-status ${r.status}">
              ${r.status === 'success' ? '‚úì' : r.status === 'failure' ? '‚úó' : r.status === 'running' ? '‚óê' : '‚óã'}
            </div>
            <div class="run-info">
              <div class="run-title">${getPipelineName(r.pipeline_id)} #${r.run_number}</div>
              <div class="run-meta">
                ${r.triggered_by || 'unknown'} ‚Ä¢ ${formatTime(r.created_at)}
              </div>
            </div>
            <div class="run-time">
              ${r.duration_ms > 0 ? formatDuration(r.duration_ms) : r.status === 'running' ? 'Running...' : '-'}
            </div>
          </div>
        `,
          )
          .join('');

        if (append) {
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = newRunsHtml;
          while (tempDiv.firstChild) {
            container.appendChild(tempDiv.firstChild);
          }
        } else {
          container.innerHTML = newRunsHtml;
        }
      }

      function viewPipelineRuns(pipelineId) {
        switchTab('runs');
      }

      async function viewRunDetail(runId) {
        stopDetailPolling();
        stepOutputOffsets.clear();
        try {
          const response = await fetch(`/api/cicd/run/detail?id=${runId}`);
          const result = await response.json();
          if (result.code === 200) {
            currentRunDetail = result.data;

            if (currentRunDetail.jobs) {
              for (const job of currentRunDetail.jobs) {
                for (const step of job.steps) {
                  if (step.output) {
                    stepOutputOffsets.set(step.id, step.output.length);
                  } else {
                    stepOutputOffsets.set(step.id, 0);
                  }
                }
              }
            }

            renderRunDetail();
            startDetailPolling(runId);
            window.location.hash = `run/${runId}`;
          }
        } catch (error) {
          console.error('Error loading run detail:', error);
        }
      }

      function startDetailPolling(runId) {
        stopDetailPolling();

        if (typeof EventSource !== 'undefined') {
          startLogEventSource(runId);
        } else {
          detailPollingInterval = setInterval(async () => {
            if (!currentRunDetail) return;
            try {
              await pollIncrementalDetail(runId);
            } catch (error) {
              console.error('Error polling run detail:', error);
            }
          }, 2000);
        }
      }

      function startLogEventSource(runId) {
        if (logEventSource) {
          logEventSource.close();
        }

        logEventSource = new EventSource(
          `/api/cicd/run/logs/stream?run_id=${runId}`,
        );

        logEventSource.addEventListener('log', (event) => {
          try {
            const logData = JSON.parse(event.data);
            appendRealtimeLog(logData);
          } catch (error) {
            console.error('Error parsing log event:', error);
          }
        });

        logEventSource.addEventListener('notice', (event) => {
          console.warn('SSE notice:', event.data);
        });

        logEventSource.addEventListener('complete', (event) => {
          console.log('SSE complete:', event.data);
          if (logEventSource) {
            logEventSource.close();
            logEventSource = null;
          }
        });

        logEventSource.onerror = (error) => {
          console.error('SSE error:', error);
          if (logEventSource) {
            logEventSource.close();
            logEventSource = null;
          }
        };
      }

      function startLegacyPolling(runId) {
        console.log('EventSource not supported, using legacy polling');
      }

      async function pollIncrementalDetail(runId) {
        const offsets = [];
        if (currentRunDetail && currentRunDetail.jobs) {
          for (const job of currentRunDetail.jobs) {
            for (const step of job.steps) {
              const offset = stepOutputOffsets.get(step.id) || 0;
              offsets.push({ step_id: step.id, offset });
            }
          }
        }

        const offsetParam = offsets.length > 0 ? JSON.stringify(offsets) : '';
        const url = offsetParam
          ? `/api/cicd/run/detail/incremental?run_id=${runId}&offsets=${encodeURIComponent(offsetParam)}`
          : `/api/cicd/run/detail/incremental?run_id=${runId}`;

        const response = await fetch(url);
        const result = await response.json();

        if (result.code === 200 && result.data) {
          updateIncrementalRunDetail(result.data);

          const isCompleted = ['success', 'failure', 'cancelled'].includes(
            result.data.run.status,
          );
          if (isCompleted) {
            stopDetailPolling();
          }
        }
      }

      function updateIncrementalRunDetail(detail) {
        if (!currentRunDetail) return;

        currentRunDetail.run = detail.run;
        updateRunDetailUI();

        if (detail.jobs) {
          for (const jobData of detail.jobs) {
            for (const stepLog of jobData.steps) {
              if (stepLog.new_output) {
                appendStepLog(stepLog.step_id, stepLog.new_output);
                stepOutputOffsets.set(stepLog.step_id, stepLog.output_length);
              }
            }
          }
        }
      }

      function appendRealtimeLog(logData) {
        const { step_id, content, is_stderr } = logData;

        if (!stepOutputOffsets.has(step_id)) {
          stepOutputOffsets.set(step_id, 0);
        }
        const currentOffset = stepOutputOffsets.get(step_id);
        stepOutputOffsets.set(step_id, currentOffset + content.length);

        appendStepLog(step_id, content, is_stderr);
      }

      function appendStepLog(stepId, content, isStderr = false) {
        const logContent = document.getElementById(
          `step-log-content-${stepId}`,
        );
        if (!logContent) return;

        if (!expandedSteps.has(stepId)) {
          expandedSteps.add(stepId);
          logContent.classList.remove('collapsed');
          const toggleIcon = document.querySelector(
            `#step-log-${stepId} .step-log-toggle-icon`,
          );
          if (toggleIcon) {
            toggleIcon.classList.remove('collapsed');
          }
        }

        const lines = content.split('\n');
        const baseTime = new Date();
        const timestampStr = baseTime.toISOString().split('T')[1].split('.')[0];

        let html = '';
        for (const line of lines) {
          if (line.trim()) {
            const coloredLine = colorizeLogLine(line);
            const lineClass = isStderr ? 'log-error' : '';
            html += `<div class="log-line ${lineClass}"><span class="log-timestamp">${timestampStr}</span>${coloredLine}</div>`;
          }
        }

        if (html) {
          if (logContent.innerHTML.includes('No output available')) {
            logContent.innerHTML = '';
          }
          logContent.insertAdjacentHTML('beforeend', html);
          logContent.scrollTop = logContent.scrollHeight;
        }
      }

      function stopDetailPolling() {
        if (detailPollingInterval) {
          clearInterval(detailPollingInterval);
          detailPollingInterval = null;
        }
        if (logEventSource) {
          logEventSource.close();
          logEventSource = null;
        }
      }

      function updateRunDetailUI() {
        const run = currentRunDetail.run;
        document.getElementById('detail-title').textContent =
          `${getPipelineName(run.pipeline_id)} #${run.run_number}`;
        document.getElementById('detail-meta').innerHTML = `
          <span class="run-status ${run.status}" style="display: inline-flex; width: 18px; height: 18px; font-size: 11px;">
            ${run.status === 'success' ? '‚úì' : run.status === 'failure' ? '‚úó' : run.status === 'running' ? '‚óê' : '‚óã'}
          </span>
          <span>${run.status}</span>
          <span>‚Ä¢</span>
          <span>${run.triggered_by || 'unknown'}</span>
          ${run.commit_hash ? `<span>‚Ä¢</span><span>${run.commit_hash.substring(0, 7)}</span>` : ''}
          ${run.duration_ms > 0 ? `<span>‚Ä¢</span><span>${formatDuration(run.duration_ms)}</span>` : ''}
        `;
        renderJobSteps();
      }

      function renderJobSteps() {
        const jobsContainer = document.getElementById('job-list');
        if (!currentRunDetail.jobs || currentRunDetail.jobs.length === 0) {
          jobsContainer.innerHTML =
            '<div class="empty-state"><p>No jobs found for this run</p></div>';
          return;
        }

        const currentJobs = jobsContainer.querySelectorAll('.job-item');
        currentRunDetail.jobs.forEach((j, jobIndex) => {
          const jobEl = currentJobs[jobIndex];
          if (!jobEl) return;

          const jobHeader = jobEl.querySelector('.job-header');
          if (jobHeader) {
            const statusEl = jobHeader.querySelector('.run-status');
            if (statusEl) {
              statusEl.className = `run-status ${j.job.status}`;
              statusEl.textContent =
                j.job.status === 'success'
                  ? '‚úì'
                  : j.job.status === 'failure'
                    ? '‚úó'
                    : j.job.status === 'running'
                      ? '‚óê'
                      : '‚óã';
            }
            const timeEl = jobHeader.querySelector('span:last-child');
            if (timeEl) {
              timeEl.textContent =
                j.job.duration_ms > 0
                  ? formatDuration(j.job.duration_ms)
                  : j.job.status === 'running'
                    ? 'Running...'
                    : '';
            }
          }

          j.steps.forEach((s, stepIndex) => {
            const stepEl = jobEl.querySelector(`[data-step-id="${s.id}"]`);
            if (stepEl) {
              const statusEl = stepEl.querySelector('.step-status');
              if (statusEl) {
                statusEl.className = `step-status ${s.status}`;
                statusEl.textContent =
                  s.status === 'success'
                    ? '‚úì'
                    : s.status === 'failure'
                      ? '‚úó'
                      : s.status === 'running'
                        ? '‚óê'
                        : s.status === 'skipped'
                          ? '‚äò'
                          : '‚óã';
              }
              const timeEl = stepEl.querySelector('.step-time');
              if (timeEl) {
                timeEl.textContent =
                  s.duration_ms > 0 ? formatDuration(s.duration_ms) : '';
              }

              const logContent = stepEl.querySelector('.step-log-content');
              if (logContent && expandedSteps.has(s.id)) {
                const currentOffset = stepOutputOffsets.get(s.id) || 0;
                const serverOutputLength = s.output ? s.output.length : 0;
                if (currentOffset <= serverOutputLength) {
                  logContent.innerHTML = formatLogOutput(
                    s.output,
                    s.started_at,
                  );
                }
              }
            }
          });
        });
      }

      function renderRunDetail() {
        document.getElementById('pipelines-view').classList.add('hidden');
        document.getElementById('runs-view').classList.add('hidden');
        document.getElementById('run-detail-view').classList.remove('hidden');

        const run = currentRunDetail.run;
        document.getElementById('detail-title').textContent =
          `${getPipelineName(run.pipeline_id)} #${run.run_number}`;
        document.getElementById('detail-meta').innerHTML = `
          <span class="run-status ${run.status}" style="display: inline-flex; width: 18px; height: 18px; font-size: 11px;">
            ${run.status === 'success' ? '‚úì' : run.status === 'failure' ? '‚úó' : run.status === 'running' ? '‚óê' : '‚óã'}
          </span>
          <span>${run.status}</span>
          <span>‚Ä¢</span>
          <span>${run.triggered_by || 'unknown'}</span>
          ${run.commit_hash ? `<span>‚Ä¢</span><span>${run.commit_hash.substring(0, 7)}</span>` : ''}
          ${run.duration_ms > 0 ? `<span>‚Ä¢</span><span>${formatDuration(run.duration_ms)}</span>` : ''}
        `;

        const jobsContainer = document.getElementById('job-list');
        if (!currentRunDetail.jobs || currentRunDetail.jobs.length === 0) {
          jobsContainer.innerHTML =
            '<div class="empty-state"><p>No jobs found for this run</p></div>';
          return;
        }

        expandedSteps.clear();
        currentRunDetail.jobs.forEach((j) => {
          j.steps.forEach((s) => expandedSteps.add(s.id));
        });

        jobsContainer.innerHTML = currentRunDetail.jobs
          .map(
            (j) => `
          <div class="job-item">
            <div class="job-header">
              <div class="run-status ${j.job.status}" style="width: 20px; height: 20px; font-size: 12px;">
                ${j.job.status === 'success' ? '‚úì' : j.job.status === 'failure' ? '‚úó' : j.job.status === 'running' ? '‚óê' : '‚óã'}
              </div>
              <span class="job-name">${escapeHtml(j.job.name)}</span>
              <span style="color: #8b949e; font-size: 12px;">
                ${j.job.duration_ms > 0 ? formatDuration(j.job.duration_ms) : j.job.status === 'running' ? 'Running...' : ''}
              </span>
            </div>
            <div class="step-list">
              ${j.steps.map((s) => renderStepItem(s)).join('')}
            </div>
          </div>
        `,
          )
          .join('');
      }

      function renderStepItem(s) {
        const isExpanded = expandedSteps.has(s.id);
        return `
          <div class="step-item" data-step-id="${s.id}">
            <div class="step-header-row">
              <div class="step-status ${s.status}">
                ${s.status === 'success' ? '‚úì' : s.status === 'failure' ? '‚úó' : s.status === 'running' ? '‚óê' : s.status === 'skipped' ? '‚äò' : '‚óã'}
              </div>
              <span class="step-name">${escapeHtml(s.name)}</span>
              <span class="step-time">${s.duration_ms > 0 ? formatDuration(s.duration_ms) : ''}</span>
            </div>
            <div class="step-log-container" id="step-log-${s.id}">
              <div class="step-log-header" data-step-id="${s.id}" onclick="toggleStepLog(${s.id})">
                <span class="step-log-toggle">
                  <span class="step-log-toggle-icon ${isExpanded ? '' : 'collapsed'}">‚ñº</span>
                  <span>Logs</span>
                </span>
                <span style="color: #8b949e; font-size: 12px;">${s.output ? s.output.split('\n').length : 0} lines</span>
              </div>
              <div class="step-log-content ${isExpanded ? '' : 'collapsed'}" id="step-log-content-${s.id}">
                ${formatLogOutput(s.output, s.started_at)}
              </div>
            </div>
          </div>
        `;
      }

      function toggleStepLog(stepId) {
        const logContent = document.getElementById(
          `step-log-content-${stepId}`,
        );
        const toggleIcon = document.querySelector(
          `#step-log-${stepId} .step-log-toggle-icon`,
        );

        if (!logContent) return;

        const isExpanded = expandedSteps.has(stepId);
        if (isExpanded) {
          expandedSteps.delete(stepId);
          logContent.classList.add('collapsed');
          toggleIcon?.classList.add('collapsed');
        } else {
          expandedSteps.add(stepId);
          logContent.classList.remove('collapsed');
          toggleIcon?.classList.remove('collapsed');
          const step = findStepById(stepId);
          if (step) {
            logContent.innerHTML = formatLogOutput(
              step.output,
              step.started_at,
            );
          }
        }
      }

      function findStepById(stepId) {
        if (!currentRunDetail || !currentRunDetail.jobs) return null;
        for (const job of currentRunDetail.jobs) {
          for (const step of job.steps) {
            if (step.id === stepId) return step;
          }
        }
        return null;
      }

      function backToRuns() {
        stopDetailPolling();
        document.getElementById('run-detail-view').classList.add('hidden');
        document.getElementById('runs-view').classList.remove('hidden');
        currentRunDetail = null;
        expandedSteps.clear();
        stepOutputOffsets.clear();
        window.location.hash = 'runs';
      }

      function formatLogOutput(output, startedAt) {
        if (!output)
          return '<div class="log-line"><span class="log-timestamp">--:--:--</span>No output available</div>';

        const lines = output.split('\n');
        const baseTime = startedAt ? new Date(startedAt) : null;
        const totalLines = lines.length;

        return lines
          .map((line, i) => {
            let timestampStr = '--:--:--';
            if (baseTime && !isNaN(baseTime.getTime())) {
              const lineTime = new Date(baseTime.getTime() + i * 1000);
              timestampStr = lineTime.toISOString().split('T')[1].split('.')[0];
            }
            const coloredLine = colorizeLogLine(line);
            return `<div class="log-line"><span class="log-timestamp">${timestampStr}</span>${coloredLine}</div>`;
          })
          .join('');
      }

      function colorizeLogLine(line) {
        if (!line) return '';

        let html = escapeHtml(line);

        if (
          html.startsWith('[Build Log]') ||
          html.startsWith('[Build Output]') ||
          html.startsWith('[Build Errors]') ||
          html.startsWith('[Run Output]') ||
          html.startsWith('[Run Errors]') ||
          html.startsWith('[Run Failed]')
        ) {
          return `<span class="log-section">${html}</span>`;
        }

        if (html.match(/^#\d+\s+\[.+\]/)) {
          html = html.replace(
            /^(#\d+\s+\[.+?\])/,
            '<span class="log-docker-step">$1</span>',
          );
        }

        if (html.includes('DONE')) {
          html = html.replace(
            /(DONE\s+\d+\.\d+s|DONE)/g,
            '<span class="log-docker-done">$1</span>',
          );
        }

        if (html.includes('CACHED')) {
          html = html.replace(
            /(CACHED)/g,
            '<span class="log-docker-cache">$1</span>',
          );
        }

        const errorPatterns = [
          /\b(Error|ERROR|Failed|FAILED|FAIL|exception|Exception|panic|Panic)\b/g,
          /\b(error:|failed:|fatal:)\b/gi,
        ];
        errorPatterns.forEach((pattern) => {
          html = html.replace(pattern, '<span class="log-error">$1</span>');
        });

        const warningPatterns = [
          /\b(Warning|WARNING|WARN|warn|warning:)\b/g,
          /\b(deprecation|deprecated|Deprecated)\b/g,
        ];
        warningPatterns.forEach((pattern) => {
          html = html.replace(pattern, '<span class="log-warning">$1</span>');
        });

        const successPatterns = [
          /\b(Success|SUCCESS|success|Passed|PASSED|pass|OK|ok)\b/g,
          /\b(successfully|completed)\b/gi,
        ];
        successPatterns.forEach((pattern) => {
          html = html.replace(pattern, '<span class="log-success">$1</span>');
        });

        const infoPatterns = [
          /\b(Info|INFO|info:)\b/g,
          /\b(Building|building|Loading|loading|Transferring|transferring)\b/g,
        ];
        infoPatterns.forEach((pattern) => {
          html = html.replace(pattern, '<span class="log-info">$1</span>');
        });

        const commandPatterns = [
          /\b(RUN|CMD|ENTRYPOINT|COPY|ADD|FROM|WORKDIR|ENV|ARG)\b/g,
          /^(\s*\$\s+)/,
        ];
        commandPatterns.forEach((pattern) => {
          html = html.replace(pattern, '<span class="log-command">$1</span>');
        });

        const hashPattern =
          /\b([a-f0-9]{64}|[a-f0-9]{40}|[a-f0-9]{32}|sha256:[a-f0-9]{64})\b/gi;
        html = html.replace(hashPattern, '<span class="log-hash">$1</span>');

        const urlPattern = /\b(https?:\/\/[^\s]+|docker-desktop:\/\/[^\s]+)/g;
        html = html.replace(
          urlPattern,
          '<span class="log-url" onclick="window.open(\'$1\', \'_blank\')">$1</span>',
        );

        html = parseAnsiCodes(html);

        return html;
      }

      function parseAnsiCodes(text) {
        const ansiColorMap = {
          30: '#24292f',
          31: '#f85149',
          32: '#3fb950',
          33: '#d29922',
          34: '#58a6ff',
          35: '#d2a8ff',
          36: '#39c5cf',
          37: '#f0f6fc',
          90: '#6e7681',
          91: '#ff7b72',
          92: '#7ee787',
          93: '#f0883e',
          94: '#79c0ff',
          95: '#d2a8ff',
          96: '#56d4dd',
          97: '#ffffff',
        };

        let result = text;

        result = result.replace(/\u001b\[(\d+)m/g, (match, code) => {
          const color = ansiColorMap[code];
          if (color) {
            return `</span><span style="color: ${color}">`;
          }
          return '';
        });

        result = result.replace(/\u001b\[0m/g, '</span><span>');

        result = result.replace(/\u001b\[[\d;]*m/g, '');

        return result;
      }

      function getPipelineName(id) {
        const p = pipelines.find((x) => x.id === id);
        return p ? p.name : `Pipeline ${id}`;
      }

      function formatTime(isoString) {
        if (!isoString) return 'unknown';
        const date = new Date(isoString);
        const now = new Date();
        const diff = Math.floor((now - date) / 1000);

        if (diff < 60) return 'just now';
        if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
        if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
        return `${Math.floor(diff / 86400)}d ago`;
      }

      function formatDuration(ms) {
        if (ms < 1000) return `${ms}ms`;
        if (ms < 60000) return `${Math.floor(ms / 1000)}s`;
        const mins = Math.floor(ms / 60000);
        const secs = Math.floor((ms % 60000) / 1000);
        return `${mins}m ${secs}s`;
      }

      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      document.querySelectorAll('.modal').forEach((modal) => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) closeModal(modal.id);
        });
      });

      async function restoreViewFromHash() {
        const hash = window.location.hash.slice(1);

        await Promise.all([loadPipelines(), loadRuns(true)]);

        if (hash.startsWith('run/')) {
          const runId = parseInt(hash.split('/')[1]);
          if (!isNaN(runId)) {
            await viewRunDetail(runId);
            document
              .querySelectorAll('.tab')
              .forEach((t) => t.classList.remove('active'));
            document
              .querySelector('.tab[onclick="switchTab(\'runs\')"]')
              ?.classList.add('active');
            return;
          }
        }
        if (hash === 'pipelines') {
          document.getElementById('pipelines-view').classList.remove('hidden');
          document.getElementById('runs-view').classList.add('hidden');
          document.getElementById('run-detail-view').classList.add('hidden');
          document
            .querySelectorAll('.tab')
            .forEach((t) => t.classList.remove('active'));
          document
            .querySelector('.tab[onclick="switchTab(\'pipelines\')"]')
            ?.classList.add('active');
        } else if (hash === 'runs') {
          document.getElementById('pipelines-view').classList.add('hidden');
          document.getElementById('runs-view').classList.remove('hidden');
          document.getElementById('run-detail-view').classList.add('hidden');
          document
            .querySelectorAll('.tab')
            .forEach((t) => t.classList.remove('active'));
          document
            .querySelector('.tab[onclick="switchTab(\'runs\')"]')
            ?.classList.add('active');
        } else {
          document.getElementById('pipelines-view').classList.add('hidden');
          document.getElementById('runs-view').classList.remove('hidden');
          document.getElementById('run-detail-view').classList.add('hidden');
          document
            .querySelectorAll('.tab')
            .forEach((t) => t.classList.remove('active'));
          document
            .querySelector('.tab[onclick="switchTab(\'runs\')"]')
            ?.classList.add('active');
        }
      }

      window.addEventListener('hashchange', restoreViewFromHash);
      restoreViewFromHash();

      async function pollRunsStatus() {
        if (isLoadingMoreRuns) return;
        try {
          const response = await fetch(
            `/api/cicd/run/list?page=1&page_size=${Math.max(runs.length, RUNS_PAGE_SIZE)}`,
          );
          const result = await response.json();
          if (result.code === 200) {
            const newRuns = result.data?.runs || [];
            const total = result.data?.total || 0;
            document.getElementById('run-count').textContent = total;

            const container = document.getElementById('run-list');
            const currentItems = container.querySelectorAll('.run-item');

            newRuns.forEach((run, index) => {
              if (index < currentItems.length) {
                const item = currentItems[index];
                const statusEl = item.querySelector('.run-status');
                const timeEl = item.querySelector('.run-time');
                if (statusEl) {
                  statusEl.className = `run-status ${run.status}`;
                  statusEl.textContent =
                    run.status === 'success'
                      ? '‚úì'
                      : run.status === 'failure'
                        ? '‚úó'
                        : run.status === 'running'
                          ? '‚óê'
                          : '‚óã';
                }
                if (timeEl) {
                  timeEl.textContent =
                    run.duration_ms > 0
                      ? formatDuration(run.duration_ms)
                      : run.status === 'running'
                        ? 'Running...'
                        : '-';
                }
              }
            });
          }
        } catch (error) {
          console.error('Error polling runs:', error);
        }
      }

      setInterval(() => {
        const isRunsViewVisible = !document
          .getElementById('runs-view')
          .classList.contains('hidden');
        if (isRunsViewVisible) {
          pollRunsStatus();
        }
      }, 5000);
    </script>
  </body>
</html>
