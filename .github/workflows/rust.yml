name: Rust

on:
  push:
    branches: [master]

env:
  CARGO_TERM_COLOR: always

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.meta.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt, clippy

      - run: cargo install toml-cli || true

      - id: meta
        run: |
          VERSION=$(toml get Cargo.toml package.version --raw)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

  check:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo fmt -- --check
      - run: cargo test --all-features
      - run: cargo clippy --all-features
      - run: cargo check --release

  sync_versions:
    needs: check
    runs-on: ubuntu-latest
    outputs:
      version: ${{ needs.setup.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - run: cargo install toml-cli || true

      - run: |
          VERSION="${{ needs.setup.outputs.version }}"
          echo "Sync version $VERSION to sub crates..."

          for dir in config plugin app init; do
            toml set $dir/Cargo.toml package.version "$VERSION"
          done

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "chore: sync versions to $VERSION"
            git push origin HEAD:${{ github.ref }}
          else
            echo "No version changes"
          fi

  publish:
    needs: sync_versions
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # IMPORTANT: checkout latest commit after sync
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - uses: dtolnay/rust-toolchain@stable

      - run: cargo install toml-cli || true

      - name: Verify version consistency
        run: |
          ROOT=$(toml get Cargo.toml package.version --raw)
          for dir in config plugin app init; do
            SUB=$(toml get $dir/Cargo.toml package.version --raw)
            if [ "$ROOT" != "$SUB" ]; then
              echo "Version mismatch: root=$ROOT $dir=$SUB"
              exit 1
            fi
          done
          echo "All versions consistent: $ROOT"

      - name: Login crates.io
        run: echo "${{ secrets.CARGO_REGISTRY_TOKEN }}" | cargo login

      - name: Publish crates in order
        run: |
          set -e
          VERSION=$(toml get Cargo.toml package.version --raw)

          publish_if_needed() {
            DIR=$1
            cd "$DIR"
            NAME=$(toml get Cargo.toml package.name --raw)

            echo "Publishing $NAME v$VERSION..."

            if cargo search "^$NAME$" | grep -q "$VERSION"; then
              echo "Already published, skipping $NAME"
            else
              cargo publish
            fi
            cd ..
          }

          publish_if_needed config
          publish_if_needed plugin
          publish_if_needed app
          publish_if_needed init
          publish_if_needed .

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=$(toml get Cargo.toml package.version --raw)
          NAME=$(toml get Cargo.toml package.name --raw)
          TAG="v$VERSION"

          git tag "$TAG" || true
          git push origin "$TAG" || true

          gh release create "$TAG" \
            --title "$TAG" \
            --notes "Release $TAG

          Package: $NAME
          Version: $VERSION

          crates.io:
          https://crates.io/crates/$NAME/$VERSION

          docs.rs:
          https://docs.rs/$NAME/$VERSION
          " --latest || \
          gh release edit "$TAG" --notes "Updated release $TAG"
