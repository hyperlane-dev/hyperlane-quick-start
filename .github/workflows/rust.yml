name: Rust

on:
  push:
    branches: [master]

env:
  CARGO_TERM_COLOR: always

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.read_root.outputs.version }}
      tag: ${{ steps.read_root.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install rust-toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt, clippy
      - name: Install toml-cli
        run: cargo install toml-cli
      - name: Read root Cargo.toml
        id: read_root
        run: |
          VERSION=$(toml get Cargo.toml package.version --raw)
          PACKAGE_NAME=$(toml get Cargo.toml package.name --raw)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Root package: $PACKAGE_NAME v$VERSION"

  publish_subpackages:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package: [config, plugin, app, init]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install toml-cli
        run: cargo install toml-cli
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      - name: Update ${{ matrix.package }} version
        run: |
          VERSION=${{ needs.setup.outputs.version }}
          PACKAGE="${{ matrix.package }}"
          echo "ðŸ”§ Updating $PACKAGE/Cargo.toml version to $VERSION"
          toml set $PACKAGE/Cargo.toml package.version $VERSION
      - name: Publish ${{ matrix.package }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          PACKAGE="${{ matrix.package }}"
          echo "ðŸ“¦ Publishing $PACKAGE..."
          (cd $PACKAGE && cargo publish --allow-dirty)

  publish_root:
    permissions:
      contents: write
    needs: publish_subpackages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      - name: Publish root package
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          VERSION=${{ needs.setup.outputs.version }}
          echo "ðŸ“¦ Publishing root package v$VERSION..."
          cargo publish --allow-dirty

  git_push:
    permissions:
      contents: write
    needs: publish_root
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Push tags and commits
        run: |
          VERSION=${{ needs.setup.outputs.version }}
          TAG="v$VERSION"
          if ! git tag -l | grep -q "^$TAG$"; then
            git tag $TAG
          fi
          git push origin master --tags
          echo "âœ… Pushed commits and tag $TAG to remote"
